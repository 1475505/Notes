
# 流水线

流水线是一种将多条指令重叠执行的实现技术。流水化提高了处理器指令的吞吐量，但由于流水线控制会产生开销，它通常还会稍微延长每条指令的执行时间。流水级之间的失衡和流水化开销也会造成限制。

## 流水线冒险

1.  数据冒险：数据冒险是指后续指令需要使用前一指令尚未完成的结果。解决方法包括停顿、数据前推、指令调度和规格化执行等。
   - 停顿（Stall）：停顿是一种简单的解决数据冒险的方法。当检测到数据冒险时，处理器会停止流水线的运行，直到冒险解除。  
  - 数据前递（Data Forwarding）：在指令完成之前，**将计算结果直接发送到后续指令所需的地方。** 这样，后续指令可以在前一指令完成之前开始执行，从而避免了停顿。数据前推需要硬件的支持，通过增加额外的寄存器和逻辑电路实现。（Reg同理）
    ![image.png](http://img.070077.xyz/20230325105302.png)
    **并不能解决所有冒险问题。** 载入指令的延迟无法简单地通过前递技术来解决 。我们需要增加一种称为*流水线互锁*的硬件来保持正确的执行模式 。 一般情况下，流水线互锁会检测冒险，并使流水线停顿，直到该冲突被清除 。
  - 指令调度（Instruction Scheduling）：指令调度是另一种解决数据冒险的方法，它通过重新组织指令的执行顺序来消除冒险。编译器在生成目标代码时，会尽量安排不相关的指令在有冒险的指令之间。
  - 规格化执行（Speculative Execution）：规格化执行是一种预测性的方法，它允许处理器在冒险可能发生之前执行后续的指令。当预测正确时，规格化执行可以提高处理器性能；当预测错误时，处理器需要撤销预测执行的结果，并重新执行正确的指令。规格化执行需要较复杂的处理器硬件支持。
2.  控制冒险：控制冒险是由于分支指令（如跳转、循环等）导致的流水线中断。**处理分支的最简单机制是冻结或冲刷流水线，即保留或删除分支之后的所有指令，直到知道分支目标为止。** 当处理器无法预测分支指令的目标地址时，后续指令的执行会受到影响。为解决控制冒险，可以使用以下方法：
    -   分支预测：通过硬件或软件预测分支的目标地址，提前将后续指令加载到流水线中。（依序后续指令位于*分支延迟槽*）
    -   延迟分支：编译器在分支指令之后插入与分支无关的指令，使得分支指令在判断分支方向时，无关的指令可以继续执行。
    -   分支目标缓冲（BTB）：使用高速缓存存储分支指令的目标地址，从而加快分支指令的执行。*分支预测缓冲区是一个小型存储器，根据分支指令地址的低位部分进行索引 。 这个存储器中包含一个位 (bit) ，表明该分支最近是否曾被选中 。*
3.  结构冒险：结构冒险是由于处理器资源共享导致的冒险。例如，当两个指令同时需要访问同一个资源（如存储器、寄存器等）时，可能会发生冲突。解决结构冒险的方法包括：
    -   资源重复：通过增加处理器资源（如寄存器、功能部件等）的数量，降低资源争用的可能性。
    -   时序调整：通过调整指令的执行顺序，避免同时访问同一资源的冲突。
4.  异常处理：当流水线中出现异常（如除以零、内存访问错误等）时，处理器需要能够正确地处理异常。解决异常处理的方法包括：
    -   确保流水线设计能够在异常发生时，正确地保存和恢复处理器状态。
    -   使用规格化执行技术，在异常发生前预测并执行后续指令。当预测错误时，撤销预测执行的结果并重新执行正确的指令。
  ![image.png](http://img.070077.xyz/20230325110944.png)


## 流水线的实现

通过增加一组寄存器实现数据路径的流水化，每对流水级之间一个寄存器：
![image.png](http://img.070077.xyz/20230325110327.png)

